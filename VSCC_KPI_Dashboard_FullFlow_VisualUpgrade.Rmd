---
title: "VSCC Challenge C — KPI Closing Dashboard"
output:
  html_document:
    theme: flatly
    toc: true
    toc_depth: 2
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999)
```

## 1) Libraries & Helpers

```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(janitor)
library(lubridate)
library(highcharter)
library(DT)
library(scales)
library(purrr)

file_path <- "[VSCC 2026] CHALLENGE C - BUSINESS CASE (DATASET).xlsx"

read_clean <- function(sheet){
  readxl::read_excel(file_path, sheet = sheet) %>%
    janitor::clean_names()
}

# EU number parser: "50.003.625" -> 50003625 ; "1451614,52" -> 1451614.52
# (No scaling heuristics; keeps numbers consistent and avoids silent 10x/1000x errors)
eu_to_num <- function(x){
  x <- as.character(x)
  x <- str_squish(x)
  x <- na_if(x, "")
  x <- str_replace_all(x, "\\.", "")
  x <- str_replace_all(x, ",", ".")
  suppressWarnings(as.numeric(x))
}

# Weighted mean helper
wmean <- function(x, w) sum(x * w, na.rm = TRUE) / sum(w, na.rm = TRUE)

# ===== Traffic-light colors (quantile-based, like group13 style) =====
clr_green  <- "#38A86F"
clr_yellow <- "#F3B735"
clr_red    <- "#DB4437"
clr_gray   <- "#455A64"
clr_blue_dark <- "#08306b"
clr_blue      <- "#2171b5"
clr_blue_mid  <- "#6baed6"
clr_blue_pale <- "#f7fbff"

hex_to_rgba <- function(hex, alpha = 1){
  hex <- gsub("#","", hex)
  r <- strtoi(substr(hex,1,2),16L)
  g <- strtoi(substr(hex,3,4),16L)
  b <- strtoi(substr(hex,5,6),16L)
  sprintf("rgba(%s,%s,%s,%s)", r,g,b,alpha)
}

# VSCC dashboard theme: white canvas + blue accents (traffic-light reserved for KPI status)
hc_theme_vscc <- function(){
  hc_theme(
    chart = list(backgroundColor = "#ffffff", style = list(fontFamily = "Inter, Segoe UI, Arial")),
    title = list(style = list(color = clr_blue_dark, fontWeight = "600")),
    subtitle = list(style = list(color = clr_gray)),
    xAxis = list(
      gridLineColor = hex_to_rgba(clr_blue_mid, 0.15),
      lineColor = hex_to_rgba(clr_blue_mid, 0.35),
      tickColor = hex_to_rgba(clr_blue_mid, 0.35),
      labels = list(style = list(color = clr_gray)),
      title  = list(style = list(color = clr_gray))
    ),
    yAxis = list(
      gridLineColor = hex_to_rgba(clr_blue_mid, 0.15),
      lineColor = hex_to_rgba(clr_blue_mid, 0.35),
      tickColor = hex_to_rgba(clr_blue_mid, 0.35),
      labels = list(style = list(color = clr_gray)),
      title  = list(style = list(color = clr_gray))
    ),
    legend = list(itemStyle = list(color = clr_gray)),
    colors = c(clr_blue, clr_blue_mid, clr_blue_dark, clr_blue_pale)
  )
}

options(highcharter.theme = hc_theme_vscc())

kpi_colors_quantile <- function(x, direction = c("high_good","low_good"), p = c(0.33, 0.66), alpha = 0.85) {
  direction <- match.arg(direction)
  q <- stats::quantile(x, probs = p, na.rm = TRUE, names = FALSE)
  if (direction == "high_good") {
    dplyr::case_when(
      x < q[1] ~ hex_to_rgba(clr_red, alpha),
      x < q[2] ~ hex_to_rgba(clr_yellow, alpha),
      TRUE ~ hex_to_rgba(clr_green, alpha)
    )
  } else {
    dplyr::case_when(
      x < q[1] ~ hex_to_rgba(clr_green, alpha),
      x < q[2] ~ hex_to_rgba(clr_yellow, alpha),
      TRUE ~ hex_to_rgba(clr_red, alpha)
    )
  }
}
```

## 2) Load Data (kept in your original flow)

```{r}
product_master    <- read_clean("ProductMaster")
country_master    <- read_clean("CountryMaster") %>%
  select(country_code, country_name, region, domestic_flag, currency)
supplier_master   <- read_clean("SupplierMaster")
supplier_material <- read_clean("SupplierMaterial")
port24            <- read_clean("Port24_Historical")
port25            <- read_clean("Port25_Historical")
dev26             <- read_clean("Dev26_Potential FCST")
financial_view    <- read_clean("FinancialView")

# PnL: read as text to avoid Excel locale/format traps
pnl_raw <- read_excel(
  file_path,
  sheet = "PnL_FY2024",
  col_types = c("text", "text", "text", "text")
) %>% clean_names()

pnl_clean <- pnl_raw %>%
  mutate(
    fy2024 = eu_to_num(fy2024),
    fy2025 = eu_to_num(fy2025),
    fy2026_projected = eu_to_num(fy2026_projected)
  ) %>%
  rename(pnl_usd = pn_l_usd)

pnl <- pnl_clean
```

## 3) Data Cleaning & Normalization

```{r}
# FX missing: USD rows => 1
port24 <- port24 %>%
  mutate(fx_rate_to_usd = if_else(currency == "USD" & is.na(fx_rate_to_usd), 1, fx_rate_to_usd))

port25 <- port25 %>%
  mutate(fx_rate_to_usd = if_else(currency == "USD" & is.na(fx_rate_to_usd), 1, fx_rate_to_usd))

# Combine + normalize (your flow)
sales_raw <- bind_rows(
  port24 %>% mutate(src_year = 2024),
  port25 %>% mutate(src_year = 2025)
) %>%
  mutate(
    req_ship_date = as.Date(req_ship_date),
    year = if_else(!is.na(year_tmp), as.integer(year_tmp), year(req_ship_date)),
    discount_rate = as.numeric(discount_rate),
    gm_percent    = as.numeric(gm_percent),
    otif_percent  = as.numeric(otif_percent),
    sales_usd     = as.numeric(sales_usd),
    sales_units   = as.numeric(sales_units)
  )

# Cost-to-serve (Outbound logistics per unit by country)
cts <- financial_view %>%
  filter(x2026_revenue_mix_targets %in% c("VN","DE","FR","ES","NL","US","TH","SG","MY")) %>%
  transmute(
    country_code = x2026_revenue_mix_targets,
    logistics_cost_perunit_usd = as.numeric(str_replace_all(as.character(x2), ",", ".")),
    cost_nature = x3,
    remarks = x4
  )

# Fact sales (join master + compute derived metrics)
fact_sales <- sales_raw %>%
  left_join(country_master, by = "country_code") %>%
  # keep portfolio_type from Port; only bring cogs & prod LT from ProductMaster
  left_join(product_master %>% select(sku, cogs_usd, std_prod_lead_time_days), by = "sku") %>%
  left_join(cts, by = "country_code") %>%
  mutate(
    list_sales_usd = if_else(!is.na(discount_rate) & discount_rate < 1,
                             sales_usd / (1 - discount_rate), NA_real_),
    discount_value_usd = list_sales_usd - sales_usd,
    gross_profit_usd = sales_usd * gm_percent,
    logistics_cost_usd = sales_units * logistics_cost_perunit_usd
  )
```

## 4) Core Performance KPIs

```{r}
kpi_year <- fact_sales %>%
  group_by(year) %>%
  summarise(
    net_sales = sum(sales_usd, na.rm = TRUE),
    gm_pct_w  = wmean(gm_percent, sales_usd),
    disc_w    = wmean(discount_rate, sales_usd),
    otif_w    = wmean(otif_percent, sales_usd),
    .groups = "drop"
  ) %>%
  arrange(year)

kpi_country <- fact_sales %>%
  group_by(country_code) %>%
  summarise(
    net_sales = sum(sales_usd, na.rm = TRUE),
    gm_pct_w  = wmean(gm_percent, sales_usd),
    disc_w    = wmean(discount_rate, sales_usd),
    otif_w    = wmean(otif_percent, sales_usd),
    .groups = "drop"
  ) %>%
  arrange(desc(net_sales))

top10 <- kpi_country %>% slice_head(n = 10)
```

### Net Sales by Year

```{r}
hchart(kpi_year, "column", hcaes(x = year, y = net_sales, color = I(clr_blue))) %>%
  hc_plotOptions(series = list(color = clr_blue)) %>%
  hc_title(text = "Net Sales by Year") %>%
  hc_yAxis(labels = list(format = "{value}")) %>%
  hc_tooltip(pointFormat = "Sales: <b>${point.y:,.0f}</b>") %>%
  hc_add_theme(hc_theme_vscc())
```

### Sales vs GM% Trend

```{r}
highchart() %>%
  hc_title(text = "Sales and GM% Trend") %>%
  hc_xAxis(categories = kpi_year$year) %>%
  hc_add_series(name = "Net Sales (USD)", type = "column",
                data = round(kpi_year$net_sales, 0)) %>%
  hc_add_series(name = "GM% (weighted)", type = "line",
                data = round(kpi_year$gm_pct_w * 100, 2),
                yAxis = 1) %>%
  hc_yAxis_multiples(
    list(title = list(text = "Net Sales"), labels = list(format = "{value}")),
    list(title = list(text = "GM%"), labels = list(format = "{value}%"), opposite = TRUE)
  ) %>%
  hc_tooltip(shared = TRUE) %>%
  hc_add_theme(hc_theme_vscc())
```

### OTIF vs GM% (bubble size = sales)

```{r}
bubble_df <- top10 %>%
  transmute(
    country = country_code,
    x = round(otif_w * 100, 2),
    y = round(gm_pct_w * 100, 2),
    z = net_sales
  )

hchart(bubble_df, "bubble", hcaes(x = x, y = y, size = z, name = country)) %>%
  hc_plotOptions(series = list(color = hex_to_rgba(clr_blue, 0.55), marker = list(lineColor = clr_blue_dark, lineWidth = 1))) %>%
  hc_title(text = "OTIF vs GM% (Top 10 markets, bubble size = sales)") %>%
  hc_xAxis(title = list(text = "OTIF (%)")) %>%
  hc_yAxis(title = list(text = "GM% (%)")) %>%
  hc_tooltip(pointFormat = "{point.name}<br>OTIF: <b>{point.x}%</b><br>GM%: <b>{point.y}%</b><br>Sales: <b>${point.z:,.0f}</b>") %>%
  hc_add_theme(hc_theme_vscc())
```

## 5) Supply (Information Flow) + Working Capital Proxies (Finance Flow)

```{r}
parse_terms_days <- function(x){
  x <- tolower(trimws(as.character(x)))
  d <- case_when(
    is.na(x) ~ NA_real_,
    str_detect(x, "net\\s*\\d+") ~ as.numeric(str_extract(x, "\\d+")),
    str_detect(x, "\\bn\\s*\\d+\\b") ~ as.numeric(str_extract(x, "\\d+")),
    str_detect(x, "cod|immediate|due on receipt|prepay|advance") ~ 0,
    TRUE ~ NA_real_
  )
  d
}

fact_supply <- supplier_material %>%
  mutate(
    moq_per_order = as.numeric(moq_per_order),
    production_lt_days = as.numeric(production_lt_days),
    unit_price = as.numeric(unit_price),
    overhead_fee_pct = as.numeric(overhead_fee_pct)
  ) %>%
  left_join(
    supplier_master %>%
      mutate(supplier_terms_days = parse_terms_days(payment_terms)) %>%
      select(supplier_id, supplier_country, payment_terms, supplier_terms_days,
             overall_supplier_score, preferred_supplier_flag, core_supplier_flag),
    by = "supplier_id"
  ) %>%
  mutate(
    is_china = supplier_country %in% c("CN","CHINA"),
    is_active = active_usage_flag == "Y"
  )

# Compliance readiness mix
compliance_mix <- fact_supply %>%
  filter(is_active) %>%
  count(compliance_status) %>%
  mutate(pct = n / sum(n)) %>%
  arrange(desc(n))

# China-origin exposure
china_exposure <- fact_supply %>%
  filter(is_active) %>%
  summarise(
    active_materials = n(),
    china_materials = sum(is_china, na.rm = TRUE),
    pct_china = china_materials / active_materials
  )

# Supplier readiness
supplier_readiness <- fact_supply %>%
  filter(is_active) %>%
  distinct(supplier_id, supplier_country, is_china, overall_supplier_score) %>%
  summarise(
    suppliers = n(),
    avg_score = mean(overall_supplier_score, na.rm = TRUE),
    pct_score_ge4 = mean(overall_supplier_score >= 4, na.rm = TRUE),
    .by = is_china
  )

# MOQ/LT pressure (top 20)
pressure_tbl <- fact_supply %>%
  filter(is_active) %>%
  mutate(pressure_raw = moq_per_order * production_lt_days) %>%
  arrange(desc(pressure_raw)) %>%
  select(material_code, supplier_id, supplier_country, compliance_status,
         moq_per_order, production_lt_days, pressure_raw) %>%
  slice_head(n = 20)

# Payment terms mismatch proxy: cash gap
fact_sales <- fact_sales %>% mutate(customer_terms_days = parse_terms_days(payment_terms))

sup_terms_ref <- fact_supply %>%
  filter(is_active) %>%
  summarise(sup_terms_avg = mean(supplier_terms_days, na.rm = TRUE)) %>%
  pull(sup_terms_avg)

cash_gap_market <- fact_sales %>%
  group_by(country_code) %>%
  summarise(
    net_sales = sum(sales_usd, na.rm = TRUE),
    cust_terms_w = wmean(customer_terms_days, sales_usd),
    .groups = "drop"
  ) %>%
  mutate(
    supplier_terms_ref = sup_terms_ref,
    cash_gap_days = cust_terms_w - supplier_terms_ref,
    cash_tied_proxy = (net_sales / 365) * cash_gap_days
  ) %>%
  arrange(desc(cash_tied_proxy))
```

### Compliance mix (traffic-light)

```{r}
comp_df <- compliance_mix %>%
  mutate(pct100 = pct * 100,
         color = kpi_colors_quantile(pct100, "high_good"))


# --- Compliance drilldown: Status -> Impact (share within status) ---
if (all(c("compliance_status","compliance_impact") %in% names(fact_supply))) {
  comp_dd <- fact_supply %>%
    filter(is_active) %>%
    count(compliance_status, compliance_impact) %>%
    group_by(compliance_status) %>%
    mutate(pct = n / sum(n)) %>%
    ungroup()

  comp_main <- comp_df %>%
    mutate(drilldown = compliance_status)

  dd_series2 <- comp_dd %>%
    group_by(compliance_status) %>%
    summarise(
      data = list(purrr::map2(coalesce(compliance_impact, "No extra impact"), pct, ~list(name=.x, y=.y))),
      .groups="drop"
    ) %>%
    transmute(
      id = compliance_status,
      name = paste0("Impact within: ", compliance_status),
      data = data,
      type = "bar"
    )

  highchart() %>%
    hc_chart(type = "column") %>%
    hc_title(text = "Compliance Mix (Active) → Drilldown by Impact") %>%
    hc_add_series(
      name = "Status",
      data = purrr::pmap(list(comp_main$compliance_status, comp_main$pct100, comp_main$color, comp_main$drilldown),
                         ~list(name=..1, y=..2, color=..3, drilldown=..4))
    ) %>%
    hc_yAxis(title = list(text = "% of active materials"), labels = list(format = "{value}%")) %>%
    hc_tooltip(pointFormat = "<b>{point.y:.1f}%</b><br/>Click to drill down") %>%
    hc_drilldown(series = list_parse(dd_series2)) %>%
    hc_add_theme(hc_theme_vscc())
} else {
  hchart(comp_df, "column", hcaes(x = compliance_status, y = pct100, color = color)) %>%
    hc_title(text = "Compliance Mix (Active)") %>%
    hc_yAxis(title = list(text = "% of active materials"), labels = list(format = "{value}%")) %>%
    hc_plotOptions(series = list(colorByPoint = TRUE)) %>%
    hc_tooltip(pointFormat = "<b>{point.y:.1f}%</b>") %>%
    hc_add_theme(hc_theme_vscc())
}

```

### China-origin exposure

```{r}
china_df <- tibble(metric = "China-origin exposure (active materials)",
                   pct = china_exposure$pct_china * 100) %>%
  mutate(color = kpi_colors_quantile(pct, "low_good"))

hchart(china_df, "bar", hcaes(x = metric, y = pct, color = color)) %>%
  hc_title(text = "China-origin Exposure") %>%
  hc_yAxis(title = list(text = "%"), labels = list(format = "{value:.0f}%")) %>%
  hc_plotOptions(series = list(colorByPoint = TRUE)) %>%
  hc_tooltip(pointFormat = "<b>{point.y:.1f}%</b>") %>%
  hc_add_theme(hc_theme_vscc())
```

### MOQ × Lead Time pressure (Top 20)

```{r}
press_df <- pressure_tbl %>%
  mutate(label = paste0(material_code, " (", supplier_country, ")")) %>%
  arrange(pressure_raw) %>%
  mutate(color = kpi_colors_quantile(pressure_raw, "low_good"))

hchart(press_df, "bar", hcaes(x = label, y = pressure_raw, color = color)) %>%
  hc_title(text = "MOQ × Lead Time Pressure (Top 20 active materials)") %>%
  hc_xAxis(title = list(text = "")) %>%
  hc_yAxis(title = list(text = "Pressure (MOQ × LT days)")) %>%
  hc_plotOptions(series = list(colorByPoint = TRUE)) %>%
  hc_tooltip(pointFormat = "Pressure: <b>{point.y:,.0f}</b>") %>%
  hc_add_theme(hc_theme_vscc())
```

### Cash gap & cash tied proxy (table)

```{r}
DT::datatable(
  cash_gap_market %>% select(country_code, net_sales, cust_terms_w, cash_gap_days, cash_tied_proxy),
  options = list(pageLength = 10),
  rownames = FALSE
)
```

## 6) Cost-to-Serve, Time-to-Market, CEO Stack

```{r}
# Cost-to-serve ratio by market
kpi_cts <- fact_sales %>%
  group_by(country_code) %>%
  summarise(
    net_sales = sum(sales_usd, na.rm = TRUE),
    logistics_cost = sum(logistics_cost_usd, na.rm = TRUE),
    cts_per_sales = logistics_cost / net_sales,
    .groups = "drop"
  ) %>%
  arrange(desc(net_sales))

# Time-to-market (core): weighted production lead time
# Note: production LT only; not cumulative inbound+production

ttm_core_market <- fact_sales %>%
  group_by(country_code) %>%
  summarise(
    net_sales = sum(sales_usd, na.rm = TRUE),
    ttm_prod_w = sum(std_prod_lead_time_days * sales_usd, na.rm = TRUE) / sum(sales_usd, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(net_sales))

# CEO stack table
ceo_stack <- kpi_cts %>%
  left_join(kpi_country %>% select(country_code, gm_pct_w, disc_w, otif_w), by = "country_code") %>%
  left_join(cash_gap_market %>% select(country_code, cash_gap_days, cash_tied_proxy), by = "country_code") %>%
  mutate(
    gm_pct_w = gm_pct_w * 100,
    disc_w = disc_w * 100,
    otif_w = otif_w * 100,
    cts_per_sales = cts_per_sales * 100
  ) %>%
  select(country_code, net_sales, gm_pct_w, disc_w, otif_w, cts_per_sales, cash_gap_days, cash_tied_proxy)

ceo_stack2 <- ceo_stack %>%
  left_join(ttm_core_market %>% select(country_code, ttm_prod_w), by = "country_code")

# Value-at-stake (simple sensitivities)
top_sales <- sum(ceo_stack2$net_sales, na.rm = TRUE)

sens_discount <- tibble(
  scenario = c("-0.5pp discount (top mkts)", "-1.0pp discount (top mkts)"),
  delta_pp = c(0.5, 1.0)
) %>% mutate(value_usd = top_sales * (delta_pp / 100))

sens_cts <- tibble(
  scenario = c("-0.3pp CTS/Sales (top mkts)", "-0.5pp CTS/Sales (top mkts)"),
  delta_pp = c(0.3, 0.5)
) %>% mutate(value_usd = top_sales * (delta_pp / 100))
```

### CEO stack table

```{r}
DT::datatable(
  ceo_stack2,
  options = list(pageLength = 10),
  rownames = FALSE
)
```

### Contribution margin proxy by market (traffic-light)

```{r}
market_profit <- fact_sales %>%
  group_by(country_code) %>%
  summarise(
    net_sales = sum(sales_usd, na.rm = TRUE),
    gross_profit = sum(gross_profit_usd, na.rm = TRUE),
    logistics_cost = sum(logistics_cost_usd, na.rm = TRUE),
    contrib_profit = gross_profit - logistics_cost,
    contrib_margin_pct = contrib_profit / net_sales,
    .groups = "drop"
  ) %>%
  arrange(desc(net_sales))

mp_top <- market_profit %>%
  slice_head(n = 10) %>%
  arrange(contrib_margin_pct) %>%
  mutate(color = kpi_colors_quantile(contrib_margin_pct, "high_good"))

hchart(mp_top, "bar", hcaes(x = country_code, y = contrib_margin_pct, color = color)) %>%
  hc_title(text = "Contribution Margin Proxy by Market (GP - Outbound CTS)") %>%
  hc_yAxis(title = list(text = "Contribution margin (proxy)"), labels = list(format = "{value:.0%}")) %>%
  hc_plotOptions(series = list(colorByPoint = TRUE)) %>%
  hc_tooltip(pointFormat = "<b>{point.y:.1%}</b>") %>%
  hc_add_theme(hc_theme_vscc())


# --- Drilldown: Market -> Category (only if required columns exist) ---
if (all(c("country_code","category","gross_profit_usd","logistics_cost_usd","sales_usd") %in% names(fact_sales))) {
  dd_market_cat <- fact_sales %>%
    group_by(country_code, category) %>%
    summarise(
      net_sales = sum(sales_usd, na.rm = TRUE),
      gross_profit = sum(gross_profit_usd, na.rm = TRUE),
      logistics_cost = sum(logistics_cost_usd, na.rm = TRUE),
      contrib_margin_pct = (gross_profit - logistics_cost) / net_sales,
      .groups = "drop"
    )

  mp_top_ids <- mp_top$country_code

  dd_series <- dd_market_cat %>%
    filter(country_code %in% mp_top_ids) %>%
    group_by(country_code) %>%
    summarise(
      data = list(purrr::map2(category, contrib_margin_pct, ~list(name = .x, y = .y))),
      .groups = "drop"
    ) %>%
    transmute(
      id = country_code,
      name = paste0("Breakdown: ", country_code),
      data = data
    ) %>%
    mutate(type = "bar")

  # Rebuild main chart with drilldown keys (keep same ordering)
  mp_main <- mp_top %>%
    mutate(drilldown = country_code)

  highchart() %>%
    hc_chart(type = "bar") %>%
    hc_title(text = "Contribution Margin Proxy by Market → Drilldown by Category") %>%
    hc_add_series(
      name = "Market",
      data = purrr::pmap(list(mp_main$country_code, mp_main$contrib_margin_pct, mp_main$color, mp_main$drilldown),
                         ~list(name = ..1, y = ..2, color = ..3, drilldown = ..4))
    ) %>%
    hc_yAxis(title = list(text = "Contribution margin (proxy)"), labels = list(format = "{value:.0%}")) %>%
    hc_tooltip(pointFormat = "<b>{point.y:.1%}</b><br/>Click to drill down") %>%
    hc_drilldown(allowPointDrilldown = TRUE, series = list_parse(dd_series)) %>%
    hc_add_theme(hc_theme_vscc())
}


```

### CEO KPI heatmap (risk score 0–100, higher = worse)

```{r}
# normalize helper
norm_0_100 <- function(x){
  rng <- range(x, na.rm = TRUE)
  if (diff(rng) == 0) return(rep(50, length(x)))
  100 * (x - rng[1]) / (rng[2] - rng[1])
}

kpi_heat <- ceo_stack2 %>%
  transmute(
    country_code,
    `GM%` = gm_pct_w,
    `Discount%` = disc_w,
    `OTIF%` = otif_w,
    `CTS/Sales%` = cts_per_sales,
    `Cash gap (days)` = cash_gap_days,
    `Prod LT (days)` = ttm_prod_w
  ) %>%
  pivot_longer(-country_code, names_to = "metric", values_to = "value") %>%
  group_by(metric) %>%
  mutate(
    score_raw = norm_0_100(value),
    risk = case_when(
      metric %in% c("GM%","OTIF%") ~ 100 - score_raw,  # high-good => lower risk
      TRUE ~ score_raw                                   # low-good => higher risk
    )
  ) %>%
  ungroup()

countries <- unique(kpi_heat$country_code)
metrics <- unique(kpi_heat$metric)

heat_dat <- kpi_heat %>%
  mutate(
    x = match(metric, metrics) - 1,
    y = match(country_code, countries) - 1
  ) %>%
  transmute(x, y, value = round(risk, 1), raw = value, metric, country_code)

highchart() %>%
  hc_chart(type = "heatmap") %>%
  hc_title(text = "CEO KPI Heatmap (Risk 0–100, higher = worse)") %>%
  hc_xAxis(categories = metrics, title = list(text = "")) %>%
  hc_yAxis(categories = countries, title = list(text = ""), reversed = TRUE) %>%
  hc_colorAxis(minColor = clr_blue_pale, maxColor = clr_blue_dark) %>%
  hc_add_series(
    name = "Risk",
    data = list_parse2(heat_dat),
    borderWidth = 1
  ) %>%
  hc_tooltip(
    useHTML = TRUE,
    pointFormat = paste0(
      "<b>{point.country_code}</b><br/>",
      "{point.metric}<br/>",
      "Raw: <b>{point.raw}</b><br/>",
      "Risk score: <b>{point.value}</b>"
    )
  ) %>%
  hc_add_theme(hc_theme_vscc())
```

### Value-at-stake (tables)

```{r}
DT::datatable(sens_discount, options = list(dom = 't'), rownames = FALSE)
DT::datatable(sens_cts, options = list(dom = 't'), rownames = FALSE)
```

## 7) Transformation (Dev 2026) + Cap 2%

```{r}
dev_summary <- dev26 %>%
  summarise(
    dev_expected_sales = sum(expected_net_sales_usd, na.rm = TRUE),
    dev_units = sum(fcst_2026_units, na.rm = TRUE)
  )

total_2026 <- pnl %>% filter(pnl_usd == "Total Net Sales") %>% pull(fy2026_projected)

cap_table <- tibble(
  total_net_sales_2026 = total_2026,
  dev_cap_2026 = total_2026 * 0.02,
  dev_pipeline = dev_summary$dev_expected_sales,
  pipeline_vs_cap = dev_summary$dev_expected_sales / (total_2026 * 0.02)
)
```

```{r}
DT::datatable(cap_table, options = list(dom = 't'), rownames = FALSE)
```

## 8) Readiness scorecard (Stage-gate proxy)

```{r}
readiness_scorecard <- tibble(
  metric = c(
    "Active materials fully compliant (Yes)",
    "Active materials not-fully compliant (Partial/No)",
    "Non-China suppliers with score >=4",
    "China suppliers with score >=4",
    "China-origin exposure (active materials)"
  ),
  value = c(
    compliance_mix$pct[compliance_mix$compliance_status == "Yes"],
    sum(compliance_mix$pct[compliance_mix$compliance_status %in% c("Partial","No")], na.rm = TRUE),
    supplier_readiness$pct_score_ge4[supplier_readiness$is_china == FALSE],
    supplier_readiness$pct_score_ge4[supplier_readiness$is_china == TRUE],
    china_exposure$pct_china
  )
) %>%
  mutate(
    value_pct = value * 100,
    direction = if_else(metric %in% c("China-origin exposure (active materials)",
                                     "Active materials not-fully compliant (Partial/No)"),
                        "low_good", "high_good"),
    color = if_else(direction == "high_good",
                    kpi_colors_quantile(value_pct, "high_good"),
                    kpi_colors_quantile(value_pct, "low_good"))
  )

hchart(readiness_scorecard, "bar", hcaes(x = metric, y = value_pct, color = color)) %>%
  hc_title(text = "Readiness Scorecard (Stage-gate proxy)") %>%
  hc_xAxis(title = list(text = "")) %>%
  hc_yAxis(title = list(text = "%"), labels = list(format = "{value:.0f}%")) %>%
  hc_plotOptions(series = list(colorByPoint = TRUE)) %>%
  hc_tooltip(pointFormat = "<b>{point.y:.1f}%</b>") %>%
  hc_add_theme(hc_theme_vscc())
```

## 9) Drilldown (Region → Country) — Contribution Profit Proxy

```{r}
# Contribution profit by region and country
# (Uses region from CountryMaster; if any region is NA, it will appear as "(Missing)")
drill_tree <- fact_sales %>%
  mutate(region = if_else(is.na(region), "(Missing)", region)) %>%
  group_by(region, country_code) %>%
  summarise(contrib_profit = sum(gross_profit_usd - logistics_cost_usd, na.rm = TRUE), .groups = "drop")

lvl1 <- drill_tree %>%
  group_by(region) %>%
  summarise(y = sum(contrib_profit), .groups = "drop") %>%
  mutate(name = region, drilldown = region,
         color = kpi_colors_quantile(y, "high_good"))

lvl2 <- drill_tree %>%
  group_by(region) %>%
  group_split() %>%
  map(~list(
    id = unique(.x$region),
    name = unique(.x$region),
    data = map2(.x$country_code, .x$contrib_profit, ~list(name = .x, y = .y))
  ))

highchart() %>%
  hc_chart(type = "column") %>%
  hc_title(text = "Contribution Profit Proxy — Region → Country") %>%
  hc_add_series(
    name = "Region",
    data = list_parse(lvl1 %>% transmute(name, y, drilldown, color)),
    colorByPoint = TRUE
  ) %>%
  hc_drilldown(series = lvl2) %>%
  hc_yAxis(title = list(text = "USD"), labels = list(format = "{value}")) %>%
  hc_tooltip(pointFormat = "<b>{point.name}</b><br/>Contribution profit: <b>${point.y:,.0f}</b>") %>%
  hc_add_theme(hc_theme_vscc())
```

## 10) Appendix Tables

### Top markets — core KPIs

```{r}
DT::datatable(
  kpi_country %>% slice_head(n = 15) %>%
    mutate(
      gm_pct_w = gm_pct_w * 100,
      disc_w = disc_w * 100,
      otif_w = otif_w * 100
    ),
  options = list(pageLength = 15),
  rownames = FALSE
)
```

### PnL sanity check

```{r}
DT::datatable(
  pnl %>% filter(pnl_usd %in% c("Net Sales - Port","Net Sales - Dev","Total Net Sales","EBITDA","EBIT")),
  options = list(pageLength = 10),
  rownames = FALSE
)
```
